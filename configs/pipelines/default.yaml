name: "entity_linking"
nodes:
  - id: "l1"
    processor: "l1_batch"
    inputs:
      input_data: {source: "$input"}
    output: {key: "l1_result"}
    config:
      model: "en_core_sci_sm"
      batch_size: 32
      min_entity_length: 2

  - id: "l2"
    processor: "l2_chain"
    requires: ["l1"]
    inputs:
      mentions: {source: "l1_result", fields: "entities[*][*].text", reduce: "flatten"}
      structure: {source: "l1_result", fields: "entities"}
    output: {key: "l2_result"}
    config:
      layers:
        - {type: "redis", priority: 1, search_mode: ["exact"], config: {host: "localhost", port: 6379, db: 0}, write: true, cache_policy: "always", ttl: 3600, field_mapping: {entity_id: "entity_id", label: "label", description: "description", entity_type: "entity_type", popularity: "popularity", aliases: "aliases"}}
        - {type: "elasticsearch", priority: 2, search_mode: ["exact", "fuzzy"], config: {hosts: ["http://localhost:9200"], index_name: "entities"}, write: true, cache_policy: "miss", ttl: 86400, field_mapping: {entity_id: "entity_id", label: "label", description: "description", entity_type: "entity_type", popularity: "popularity", aliases: "aliases"}, fuzzy: {max_distance: 2, min_similarity: 0.3, prefix_length: 1}}
        - {type: "postgres", priority: 3, search_mode: ["fuzzy"], config: {host: "localhost", port: 5432, database: "entities_db", user: "postgres", password: "postgres"}, write: false, field_mapping: {entity_id: "entity_id", label: "label", description: "description", entity_type: "entity_type", popularity: "popularity", aliases: "aliases"}, fuzzy: {min_similarity: 0.3}}
      max_candidates: 5

  - id: "l3"
    processor: "l3_batch"
    requires: ["l2"]
    inputs:
      texts: {source: "$input", fields: "texts"}
      candidates: {source: "l2_result", fields: "candidates"}
    output: {key: "l3_result"}
    config:
      model_name: "BioMike/GLiNER-anon"
      token: "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"
      device: "cpu"
      threshold: 0.1
      max_length: 512
    schema:
      template: "{label} {description}"

  - id: "l0"
    processor: "l0_aggregator"
    requires: ["l1", "l2", "l3"]
    inputs:
      l1_entities: {source: "l1_result", fields: "entities"}
      l2_candidates: {source: "l2_result", fields: "candidates"}
      l3_entities: {source: "l3_result", fields: "entities"}
    output: {key: "l0_result"}
    config:
      min_confidence: 0.0
      include_unlinked: true
      return_all_candidates: false
      strict_matching: true
      position_tolerance: 2
    schema:
      template: "{label} {description}"